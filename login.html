<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ثبت محصول در انبار</title>
    <!-- فونت فارسی Vazirmatn از Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/firouzeh_assistant/manifest.json">
    <!-- Bootstrap CDN برای tooltip -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome برای آیکون‌ها -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        /* استایل‌های شما دقیقاً مثل قبل */
        :root {
            --primary-color: #00796b;
            --secondary-color: #004d40;
            --background-color: #f5f5f5;
            --text-color: #212121;
            --border-color: #d0d0d0;
            --error-color: #d32f2f;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            direction: rtl;
            text-align: right;
        }

        form {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--secondary-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }

        input[type="file"] {
            display: none;
        }

        .category-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .category-group select {
            flex: 2;
        }

        .category-group button {
            flex: 1;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .category-group button:hover {
            background: var(--secondary-color);
        }

        .code-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .code-group input {
            flex: 1;
        }

        .code-group span {
            font-size: 0.9em;
            color: #666;
        }

        .inventory-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .prices-group {
            display: flex;
            gap: 10px;
        }

        .prices-group div {
            flex: 1;
        }

        .tooltip-text {
            color: var(--primary-color);
            cursor: help;
            text-decoration: underline dotted;
        }

        .submit-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1.1em;
        }

        .submit-btn:hover {
            background: var(--secondary-color);
        }

        /* مدال برای دسته‌بندی جدید */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .modal-content input {
            margin-bottom: 10px;
        }

        .modal-content button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            cursor: pointer;
            border-radius: 4px;
        }

        .modal-content button:hover {
            background: var(--secondary-color);
        }

        .close-modal {
            float: left;
            cursor: pointer;
            font-size: 1.5em;
        }

        .product-name-group {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .product-name-group input {
            flex: 1;
            min-width: 250px;
        }

        .image-preview {
            position: relative;
            flex: 0 0 100px;
            width: 100px;
            height: 100px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: #fafafa;
            transition: box-shadow 0.3s, border-color 0.3s;
        }

        .image-preview:hover {
            box-shadow: 0 0 8px rgba(0,121,107,0.4);
            border-color: var(--primary-color);
        }

        .image-preview i {
            font-size: 1.2em;
            color: var(--primary-color);
        }

        .image-preview span {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .image-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 20;
            width: 160px;
            margin-top: 5px;
        }

        .image-menu button {
            display: block;
            width: 100%;
            padding: 12px;
            background: none;
            border: none;
            text-align: right;
            cursor: pointer;
            font-size: 0.95em;
        }

        .image-menu button:hover {
            background: var(--background-color);
        }

        .unit-select {
            width: 120px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
        }

        .inventory-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .inventory-group input {
            flex: 1;
        }

        @media (max-width: 600px) {
            .category-group, .code-group, .prices-group {
                flex-direction: column;
                align-items: stretch;
            }

            .image-preview {
                flex: 0 0 50px;
                width: 80px;
                height: 50px;
            }

            .image-preview i {
                font-size: 1.5em;
            }

            .image-preview span {
                font-size: 0.75em;
            }

            .product-name-group input {
                min-width: 200px;
            }
        }

        @media (max-width: 400px) {
            .product-name-group {
                flex-direction: column;
            }

            .image-preview {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <form id="product-form">
        <!-- نام کالا و عکس محصول -->
        <label for="product_name">نام کالا:</label>
        <div class="product-name-group">
            <div class="image-preview" id="image_preview">
                <i class="fas fa-camera"></i>
            </div>
            <input type="text" id="product_name" required>
        </div>

        <!-- inputهای پنهان برای عکس -->
        <input type="file" id="file_input" accept="image/*">
        <input type="file" id="camera_input" accept="image/*" capture="environment">

        <!-- منوی گزینه‌های عکس -->
        <div class="image-menu" id="image_menu">
            <button id="take_photo">گرفتن عکس جدید</button>
            <button id="select_gallery">انتخاب از گالری</button>
        </div>

        <!-- دسته‌بندی و کد محصول -->
        <label>دسته‌بندی محصول:</label>
        <div class="category-group">
            <select id="category_select" required>
                <option value="">در حال بارگذاری...</option>
            </select>
            <button type="button" id="new_category_btn">ساخت دسته‌بندی جدید</button>
        </div>

        <label for="product_code">کد محصول:</label>
        <div class="code-group">
            <input type="text" id="product_code" maxlength="6" pattern="^\d{2}-\d{3}$" placeholder="XX-XXX" required title="فرمت باید XX-XXX باشد (عددهای ۰-۹)">
            <span>(دو رقم اول نشان‌دهنده دسته‌بندی)</span>
        </div>

        <!-- موجودی -->
        <label for="inventory_count">تعداد موجود در انبار:</label>
        <div class="inventory-toggle">
            <input type="checkbox" id="unlimited_checkbox" checked>
            <label for="unlimited_checkbox">موجودی نامحدود</label>
        </div>
        <div class="inventory-group">
            <input type="text" id="inventory_count" value="نامحدود" disabled>
            <select class="unit-select" id="unit_select">
                <option value="عدد" selected>عدد</option>
                <option value="کیلوگرم">کیلوگرم</option>
            </select>
        </div>

        <!-- قیمت‌ها -->
        <label>قیمت‌ها:</label>
        <div class="prices-group">
            <div>
                <label for="cost_price">قیمت تمام‌شده (ریال):</label>
                <input type="number" id="cost_price" min="0" required>
            </div>
            <div>
                <label for="sell_price">قیمت فروش (ریال):</label>
                <input type="number" id="sell_price" min="0" required>
            </div>
        </div>
        <p class="tooltip-text" data-bs-toggle="tooltip" data-bs-placement="top" title="قیمت تمام شده شامل هزینه‌های تولید، مواد اولیه و غیره است که پایه محاسبه سود است.">قیمت تمام شده به چه معناست؟</p>

        <!-- توضیحات -->
        <label for="description">توضیحات بیشتر (اختیاری):</label>
        <textarea id="description"></textarea>

        <!-- submit -->
        <button type="submit" class="submit-btn">ذخیره در انبار</button>
    </form>

    <!-- مدال برای دسته‌بندی جدید -->
    <div class="modal" id="category_modal">
        <div class="modal-content">
            <span class="close-modal" id="close_modal">×</span>
            <label for="new_category_name">نام دسته‌بندی جدید:</label>
            <input type="text" id="new_category_name" required>
            <button type="button" id="save_category">ذخیره</button>
        </div>
    </div>

    <script>
        // ============================================
        // تنظیمات پایه API
        // ============================================
        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        const BUSINESS_ID = 1;
        
        const getAuthToken = () => {
            return localStorage.getItem('access_token') || '';
        };

        // ============================================
        // توابع کمکی
        // ============================================
        function showMessage(message, type = 'success') {
            const msgDiv = document.createElement('div');
            msgDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 start-50 translate-middle-x mt-3`;
            msgDiv.style.zIndex = '9999';
            msgDiv.style.minWidth = '300px';
            msgDiv.style.textAlign = 'center';
            msgDiv.innerHTML = message;
            document.body.appendChild(msgDiv);
            
            setTimeout(() => msgDiv.remove(), 3000);
        }

        function getUnitValue(unitText) {
            const unitMap = {
                'عدد': 'number',
                'کیلوگرم': 'kg',
                'لیتر': 'liter'
            };
            return unitMap[unitText] || 'number';
        }

        // ============================================
        // دریافت لیست دسته‌بندی‌ها از سرور
        // ============================================
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories/`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) throw new Error('خطا در دریافت دسته‌بندی‌ها');
                
                const categories = await response.json();
                const select = document.getElementById('category_select');
                select.innerHTML = '<option value="">انتخاب کنید</option>';
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = `${cat.name} (${cat.category_code})`;
                    option.dataset.code = cat.category_code;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('خطا:', error);
                showMessage('خطا در دریافت لیست دسته‌بندی‌ها', 'error');
            }
        }

        // ============================================
        // ساخت دسته‌بندی جدید
        // ============================================
        async function createCategory(categoryName) {
            try {
                const response = await fetch(`${API_BASE_URL}/categories/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: categoryName })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'خطا در ساخت دسته‌بندی');
                }
                
                const newCategory = await response.json();
                showMessage('دسته‌بندی با موفقیت ساخته شد');
                
                await loadCategories();
                
                const select = document.getElementById('category_select');
                Array.from(select.options).forEach(option => {
                    if (option.value == newCategory.id) {
                        option.selected = true;
                    }
                });
                
                return newCategory;
                
            } catch (error) {
                console.error('خطا:', error);
                showMessage(error.message, 'error');
                return null;
            }
        }

        // ============================================
        // تابع اصلی ثبت محصول
        // ============================================
        async function submitProduct(formData) {
            try {
                if (!formData.name) throw new Error('نام کالا را وارد کنید');
                if (!formData.category) throw new Error('دسته‌بندی را انتخاب کنید');
                if (!formData.cost || formData.cost <= 0) throw new Error('قیمت تمام شده را وارد کنید');
                if (!formData.price || formData.price <= 0) throw new Error('قیمت فروش را وارد کنید');
                
                const response = await fetch(`${API_BASE_URL}/products/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'خطا در ثبت محصول');
                }
                
                const result = await response.json();
                showMessage(`✅ محصول با کد ${result.product_code} با موفقیت ثبت شد`);
                resetForm();
                return result;
                
            } catch (error) {
                console.error('خطا:', error);
                showMessage(error.message, 'error');
                return null;
            }
        }

        function resetForm() {
            document.getElementById('product_name').value = '';
            document.getElementById('category_select').value = '';
            document.getElementById('product_code').value = '';
            document.getElementById('cost_price').value = '';
            document.getElementById('sell_price').value = '';
            document.getElementById('description').value = '';
            document.getElementById('image_preview').innerHTML = '<i class="fas fa-camera"></i>';
            document.getElementById('unlimited_checkbox').checked = true;
            document.getElementById('inventory_count').value = 'نامحدود';
            document.getElementById('inventory_count').disabled = true;
        }

        function prepareFormData() {
            const categorySelect = document.getElementById('category_select');
            const unitSelect = document.getElementById('unit_select');
            const unlimited = document.getElementById('unlimited_checkbox').checked;
            
            const productData = {
                name: document.getElementById('product_name').value.trim(),
                category: categorySelect.value,
                unit: getUnitValue(unitSelect.value),
                cost: parseInt(document.getElementById('cost_price').value) || 0,
                price: parseInt(document.getElementById('sell_price').value) || 0,
                description: document.getElementById('description').value.trim() || '',
                unlimited_stock: unlimited,
            };
            
            const manualCode = document.getElementById('product_code').value.trim();
            if (manualCode) {
                productData.product_code = manualCode.replace('-', '');
            }
            
            return productData;
        }

        async function uploadProductImage(productId, imageFile) {
            if (!imageFile) return;
            
            const formData = new FormData();
            formData.append('image', imageFile);
            
            try {
                await fetch(`${API_BASE_URL}/products/${productId}/upload-image/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` },
                    body: formData
                });
            } catch (error) {
                console.warn('خطا در آپلود عکس:', error);
            }
        }

        async function login(username, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/token/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    return true;
                }
            } catch (error) {
                console.error('خطا در ورود:', error);
            }
            return false;
        }

        // ============================================
        // رویدادهای اصلی
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            
            // مدیریت باکس عکس
            const imagePreview = document.getElementById('image_preview');
            const imageMenu = document.getElementById('image_menu');
            const fileInput = document.getElementById('file_input');
            const cameraInput = document.getElementById('camera_input');
            const takePhotoBtn = document.getElementById('take_photo');
            const selectGalleryBtn = document.getElementById('select_gallery');

            imagePreview.addEventListener('click', (e) => {
                e.stopPropagation();
                imageMenu.style.display = 'block';
            });

            document.addEventListener('click', (e) => {
                if (!imagePreview.contains(e.target)) {
                    imageMenu.style.display = 'none';
                }
            });

            selectGalleryBtn.addEventListener('click', () => fileInput.click());
            takePhotoBtn.addEventListener('click', () => cameraInput.click());

            function handleFileSelect(input) {
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            imagePreview.innerHTML = `<img src="${event.target.result}" alt="عکس محصول">`;
                        };
                        reader.readAsDataURL(file);
                    }
                    imageMenu.style.display = 'none';
                });
            }

            handleFileSelect(fileInput);
            handleFileSelect(cameraInput);

            // مدیریت چک‌باکس نامحدود
            const unlimitedCheckbox = document.getElementById('unlimited_checkbox');
            const countInput = document.getElementById('inventory_count');

            unlimitedCheckbox.addEventListener('change', () => {
                if (unlimitedCheckbox.checked) {
                    countInput.disabled = true;
                    countInput.value = 'نامحدود';
                } else {
                    countInput.disabled = false;
                    countInput.value = '0';
                    countInput.focus();
                }
            });

            // مدال دسته‌بندی
            const modal = document.getElementById('category_modal');
            const newBtn = document.getElementById('new_category_btn');
            const closeBtn = document.getElementById('close_modal');
            const saveBtn = document.getElementById('save_category');
            const newCatInput = document.getElementById('new_category_name');

            newBtn.addEventListener('click', () => modal.style.display = 'flex');
            closeBtn.addEventListener('click', () => modal.style.display = 'none');
            window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

            // Tooltip Bootstrap
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

            // بارگذاری دسته‌بندی‌ها از سرور
            await loadCategories();

            // ========================================
            // مدیریت ثبت محصول
            // ========================================
            document.getElementById('product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال ثبت...';
                submitBtn.disabled = true;
                
                try {
                    const productData = prepareFormData();
                    const result = await submitProduct(productData);
                    
                    if (result && (fileInput.files[0] || cameraInput.files[0])) {
                        const imageFile = fileInput.files[0] || cameraInput.files[0];
                        await uploadProductImage(result.id, imageFile);
                    }
                    
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });

            // ========================================
            // مدیریت ساخت دسته‌بندی جدید
            // ========================================
            saveBtn.addEventListener('click', async () => {
                const newCatName = newCatInput.value.trim();
                
                if (!newCatName) {
                    showMessage('لطفاً نام دسته‌بندی را وارد کنید', 'error');
                    return;
                }
                
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال ثبت...';
                saveBtn.disabled = true;
                
                try {
                    await createCategory(newCatName);
                    modal.style.display = 'none';
                    newCatInput.value = '';
                } finally {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            });

            // ========================================
            // مدیریت کد محصول
            // ========================================
            const categorySelect = document.getElementById('category_select');
            const productCodeInput = document.getElementById('product_code');

            categorySelect.addEventListener('change', () => {
                if (categorySelect.value) {
                    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                    const categoryCode = selectedOption.dataset.code;
                    
                    if (!productCodeInput.value) {
                        const randomPart = Math.floor(Math.random() * 900 + 100);
                        productCodeInput.value = `${categoryCode}-${randomPart}`;
                    }
                }
            });

            productCodeInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value.length > 5) value = value.slice(0, 5);
                
                if (value.length > 2) {
                    e.target.value = `${value.slice(0, 2)}-${value.slice(2)}`;
                } else {
                    e.target.value = value;
                }
            });
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/firouzeh_assistant/sw.js')
                    .then(reg => console.log('Service Worker ثبت شد!', reg))
                    .catch(err => console.log('خطا:', err));
            });
        }
    </script>
</body>
</html>